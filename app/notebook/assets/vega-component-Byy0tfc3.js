import{bk as N,bl as G,bm as E,c as D,aT as W,bn as $,j as g,E as q,U as C,Q as j,bo as T,bp as A,bq as B,L as _,aG as K,br as Q,bs as R,bt as U,bu as J,a4 as X,bv as Y}from"./index-_Zd2Tjcq.js";import{M as y}from"./compile-DMqlw2f3.js";import{a as ee}from"./VegaLite-D_9sSEjl.js";import"./time-BJthvF8K.js";import"./timer-B5eI7Tcu.js";import"./linear-D5JcW2cD.js";import"./init-DLRA0X12.js";import"./range-CtcPcB_L.js";import"./zoom-COrs4lFh.js";import"./ordinal-DDUp3AbE.js";import"./colors-bszWmPJw.js";import"./arc-ZB5pDULS.js";import"./step-BwsUM5iJ.js";import"./index-mKg8eShI.js";function L(e){return(t=e,t!=null&&t.schema&&Array.isArray(t.schema.fields)&&typeof t.toArray=="function"?e:function(r){return G(r,{useProxy:!0})}(e)).toArray();var t}L.responseType="arrayBuffer";const V=new Set(["boxplot","errorband","errorbar"]),S={getMarkType(e){const t=typeof e=="string"?e:e.type;if(V.has(t))throw new Error("Not supported");return t},isInteractive(e){const t=typeof e=="string"?e:e.type;return!V.has(t)},makeClickable(e){const t=typeof e=="string"?e:e.type;return t in y?typeof e=="string"?{type:e,cursor:"pointer",tooltip:!0}:{...e,type:t,cursor:"pointer",tooltip:!0}:e},getOpacity:e=>typeof e=="string"?null:"opacity"in e&&typeof e.opacity=="number"?e.opacity:null},te=new Set(["color","fill","fillOpacity","opacity","shape","size"]);function ne(e,t,r,i){const u={and:r.map(d=>({param:d}))};if(e==="opacity"){const d=S.getOpacity(i)||1;return{...t,opacity:{condition:{test:u,value:d},value:d/5}}}return t}const w={point:e=>e==null?"select_point":`select_point_${e}`,interval:e=>e==null?"select_interval":`select_interval_${e}`,legendSelection:e=>`legend_selection_${e}`,HIGHLIGHT:"highlight",PAN_ZOOM:"pan_zoom",hasPoint:e=>e.some(t=>t.startsWith("select_point")),hasInterval:e=>e.some(t=>t.startsWith("select_interval")),hasLegend:e=>e.some(t=>t.startsWith("legend_selection")),hasPanZoom:e=>e.some(t=>t.startsWith("pan_zoom"))},P={highlight:()=>({name:w.HIGHLIGHT,select:{type:"point",on:"mouseover"}}),interval:(e,t)=>({name:w.interval(t),select:{type:"interval",encodings:Z(e),mark:{fill:"#669EFF",fillOpacity:.07,stroke:"#669EFF",strokeOpacity:.4},on:"[mousedown[!event.metaKey], mouseup] > mousemove[!event.metaKey]",translate:"[mousedown[!event.metaKey], mouseup] > mousemove[!event.metaKey]"}}),point:(e,t)=>({name:w.point(t),select:{type:"point",encodings:Z(e),on:"click[!event.metaKey]"}}),legend:e=>({name:w.legendSelection(e),select:{type:"point",fields:[e]},bind:"legend"}),panZoom:()=>({name:w.PAN_ZOOM,bind:"scales",select:{type:"interval",on:"[mousedown[event.metaKey], window:mouseup] > window:mousemove!",translate:"[mousedown[event.metaKey], window:mouseup] > window:mousemove!",zoom:"wheel![event.metaKey]"}})};function Z(e){switch(S.getMarkType(e.mark)){case y.image:case y.trail:return;case y.area:case y.arc:return["color"];case y.bar:{const t=function(r){var d,l;if(!r||!("mark"in r))return;const i=(d=r.encoding)==null?void 0:d.x,u=(l=r.encoding)==null?void 0:l.y;if(i&&"type"in i&&i.type==="nominal")return"vertical";if(u&&"type"in u&&u.type==="nominal"||i&&"aggregate"in i)return"horizontal";if(u&&"aggregate"in u)return"vertical"}(e);return t==="horizontal"?["y"]:t==="vertical"?["x"]:void 0}case y.circle:case y.geoshape:case y.line:case y.point:case y.rect:case y.rule:case y.square:case y.text:case y.tick:return["x","y"]}}function z(e){return"params"in e&&e.params&&e.params.length>0?e.params.filter(t=>t!=null&&"select"in t&&t.select!==void 0).map(t=>t.name):"layer"in e?[...new Set(e.layer.flatMap(z))]:[]}function ae(e,t){var f,v;let{chartSelection:r=!0,fieldSelection:i=!0}=t;if(!r&&!i)return e;if(((f=e.params)==null?void 0:f.some(c=>c.bind==="legend"))&&(i=!1),((v=e.params)==null?void 0:v.some(c=>!c.bind))&&(r=!1),"vconcat"in e){const c=e.vconcat.map(o=>"mark"in o?M(o):o);return{...e,vconcat:c}}if("hconcat"in e){const c=e.hconcat.map(o=>"mark"in o?M(o):o);return{...e,hconcat:c}}if("layer"in e){const c=e.layer.map((o,p)=>{if(!("mark"in o))return o;let s=o;return s=H(s,r,p),s=M(s),p===0&&(s=F(s)),s});return{...e,layer:c}}if(!("mark"in e)||!S.isInteractive(e.mark))return e;let l=e;return l=function(c,o){if(o===!1)return c;let p=function(h){if(!h||!("encoding"in h))return[];const{encoding:x}=h;return x?Object.entries(x).flatMap(n=>{const[a,m]=n;return m&&te.has(a)?"field"in m&&typeof m.field=="string"?[m.field]:"condition"in m&&m.condition&&typeof m.condition=="object"&&"field"in m.condition&&m.condition.field&&typeof m.condition.field=="string"?[m.condition.field]:[]:[]}):[]}(c);Array.isArray(o)&&(p=p.filter(h=>o.includes(h)));const s=p.map(h=>P.legend(h)),b=[...c.params||[],...s];return{...c,params:b}}(l,i),l=H(l,r,void 0),l=M(l),l=F(l),l}function H(e,t,r){if(t===!1)return e;let i;try{i=S.getMarkType(e.mark)}catch{return e}if(i==="geoshape")return e;const u=t===!0?function(f){switch(f){case"arc":case"area":return["point"];case"text":case"bar":default:return["point","interval"];case"line":return}}(i):[t];if(!u)return e;const d=u.map(f=>f==="interval"?P.interval(e,r):P.point(e,r)),l=[...e.params||[],...d];return{...e,params:l}}function F(e){let t;try{t=S.getMarkType(e.mark)}catch{}if(t==="geoshape")return e;const r=e.params||[];return r.some(i=>i.bind==="scales")?e:{...e,params:[...r,P.panZoom()]}}function M(e){const t="encoding"in e?e.encoding:void 0,r=e.params||[],i=r.map(u=>u.name);return r.length===0?e:S.isInteractive(e.mark)?{...e,mark:S.makeClickable(e.mark),encoding:ne("opacity",t||{},i,e.mark)}:e}$("arrow",L);const re=e=>{const t=D.c(11),{value:r,setValue:i,chartSelection:u,fieldSelection:d,spec:l}=e;let f,v;t[0]!==l?(f=async()=>async function(s){if(!s)return s;const b="datasets"in s?{...s.datasets}:{},h=async n=>{if(!n)return n;if("layer"in n){const k=await Promise.all(n.layer.map(h));n={...n,layer:k}}if("hconcat"in n){const k=await Promise.all(n.hconcat.map(h));n={...n,hconcat:k}}if("vconcat"in n){const k=await Promise.all(n.vconcat.map(h));n={...n,vconcat:k}}if("spec"in n&&(n={...n,spec:await h(n.spec)}),!n.data||!("url"in n.data))return n;let a;try{a=N(n.data.url)}catch{return n}const m=await E(a.href,n.data.format);return b[a.pathname]=m,{...n,data:{name:a.pathname}}},x=await h(s);return Object.keys(b).length===0?x:{...x,datasets:b}}(l),v=[l],t[0]=l,t[1]=f,t[2]=v):(f=t[1],v=t[2]);const{data:c,error:o}=W(f,v);if(o){let s;return t[3]!==o?(s=g.jsx(q,{error:o}),t[3]=o,t[4]=s):s=t[4],s}if(!c)return null;let p;return t[5]!==u||t[6]!==d||t[7]!==c||t[8]!==i||t[9]!==r?(p=g.jsx(ie,{value:r,setValue:i,chartSelection:u,fieldSelection:d,spec:c}),t[5]=u,t[6]=d,t[7]=c,t[8]=i,t[9]=r,t[10]=p):p=t[10],p},ie=({value:e,setValue:t,chartSelection:r,fieldSelection:i,spec:u})=>{const{theme:d}=C(),l=j.useRef(void 0),[f,v]=j.useState(),c=T(u),o=j.useMemo(()=>ae(function(a){return a.data&&"url"in a.data&&(a.data.url=N(a.data.url).href),a}(c),{chartSelection:r,fieldSelection:i}),[c,r,i]),p=j.useMemo(()=>z(o),[o]),s=A(a=>{t({...e,...a})}),b=T(p),h=j.useMemo(()=>b.reduce((a,m)=>(w.PAN_ZOOM===m||(a[m]=B((k,I)=>{_.debug("[Vega signal]",k,I);let O=K.mapValues(I,ce);O=K.mapValues(O,se),s({[k]:O})},100)),a),{}),[b,s]),x=A(a=>{_.error(a),_.debug(o),v(a)}),n=A(a=>{_.debug("[Vega view] created",a),l.current=a,v(void 0)});return g.jsxs(g.Fragment,{children:[f&&g.jsxs(Q,{variant:"destructive",children:[g.jsx(R,{children:f.message}),g.jsx("div",{className:"text-md",children:f.stack})]}),g.jsxs("div",{className:"relative",onPointerDown:U.stopPropagation(),children:[g.jsx(ee,{spec:o,theme:d==="dark"?"dark":void 0,actions:oe,signalListeners:h,onError:x,onNewView:n}),(()=>{const a=[];return w.hasPoint(p)&&a.push(["Point selection","click to select a point; hold shift for multi-select"]),w.hasInterval(p)&&a.push(["Interval selection","click and drag to select an interval"]),w.hasLegend(p)&&a.push(["Legend selection","click to select a legend item; hold shift for multi-select"]),w.hasPanZoom(p)&&a.push(["Pan","hold the meta key and drag"],["Zoom","hold the meta key and scroll"]),a.length===0?null:g.jsx(X,{delayDuration:300,side:"left",content:g.jsx("div",{className:"text-xs flex flex-col",children:a.map((m,k)=>g.jsxs("div",{children:[g.jsxs("span",{className:"font-bold tracking-wide",children:[m[0],":"]})," ",m[1]]},k))}),children:g.jsx(Y,{className:"absolute bottom-1 right-0 m-2 h-4 w-4 cursor-help text-muted-foreground hover:text-foreground"})})})()]})]})},oe={source:!1,compiled:!1};function se(e){return e instanceof Set?[...e]:e}function ce(e){return Array.isArray(e)?e.map(t=>t instanceof Date&&J(t)?new Date(t).getTime():t):e}export{re as default};
